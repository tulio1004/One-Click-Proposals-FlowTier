<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal Builder — FlowTier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/index.css">
</head>
<body>

  <div class="builder-layout">

    <!-- LEFT: Form Panel -->
    <div class="builder-form-panel" id="formPanel">

      <div class="builder-header">
        <div>
          <img src="/static/images/logo.webp" alt="FlowTier" style="height:36px;margin-bottom:4px;">
          <h1>Proposal Builder</h1>
        </div>
        <div class="action-bar">
          <a href="/" class="btn btn-secondary btn-sm" style="text-decoration:none;">Dashboard</a>
          <button class="btn btn-secondary btn-sm" onclick="copyJSON()">Copy JSON</button>
          <button class="btn btn-secondary btn-sm" onclick="downloadJSON()">Download JSON</button>
          <button class="btn btn-secondary btn-sm" onclick="loadJSON()">Load JSON</button>
          <a href="/logout" class="btn btn-secondary btn-sm" style="text-decoration:none;">Logout</a>
        </div>
      </div>

      <!-- A) Client Information -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">A</span> Client Information
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" placeholder="John Smith">
          </div>
          <div class="form-group">
            <label for="clientCompany">Company</label>
            <input type="text" id="clientCompany" placeholder="Acme Corp">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail" placeholder="john@acme.com">
          </div>
          <div class="form-group">
            <label for="clientPhone">Phone</label>
            <input type="tel" id="clientPhone" placeholder="+1 (555) 123-4567">
          </div>
        </div>
      </div>

      <!-- B) Project Details -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">B</span> Project Details
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="projectName">Project Name</label>
            <input type="text" id="projectName" placeholder="Operations Automation">
          </div>
          <div class="form-group">
            <label for="proposalId">Proposal ID</label>
            <div class="dropdown-add-row">
              <input type="text" id="proposalId" placeholder="FT26P01" style="flex:1;">
              <button class="btn btn-primary btn-sm" type="button" onclick="generateProposalId()">Generate</button>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="proposalSlug">Slug (auto-generated)</label>
            <input type="text" id="proposalSlug" placeholder="auto-generated-from-company" readonly style="opacity:0.7;cursor:default;">
          </div>
          <div class="form-group">
            <label for="proposalDate">Date</label>
            <input type="date" id="proposalDate">
          </div>
        </div>
      </div>

      <!-- C) Problem -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">C</span> Problem
        </div>
        <div class="form-group">
          <label for="problemDraft">Problem Statement (Draft)</label>
          <textarea id="problemDraft" rows="4" placeholder="Describe the client's current challenges..."></textarea>
        </div>
      </div>

      <!-- D) Solution -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">D</span> Solution
        </div>
        <div class="form-group">
          <label for="solutionDraft">Solution Overview (Draft)</label>
          <textarea id="solutionDraft" rows="4" placeholder="Describe the proposed solution..."></textarea>
        </div>
      </div>

      <!-- E) Systems Selection -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">E</span> Systems
        </div>
        <div class="form-group">
          <label for="systemDropdown">Add a System</label>
          <div class="dropdown-add-row">
            <select id="systemDropdown">
              <option value="">— Select a system to add —</option>
            </select>
            <button class="btn btn-primary btn-sm" id="addSystemBtn" type="button">Add</button>
          </div>
        </div>
        <div id="addedSystemsList"></div>
      </div>

      <!-- F) Scope of Work -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">F</span> Scope of Work
        </div>
        <div id="scopeList"></div>
        <button class="add-item-btn" onclick="addScopeItem()">+ Add Item</button>
      </div>

      <!-- G) Timeline -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">G</span> Timeline
        </div>
        <div id="milestoneList"></div>
        <button class="add-item-btn" onclick="addMilestone()">+ Add Milestone</button>
      </div>

      <!-- H) Pricing -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">H</span> Pricing
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="pricingCurrency">Currency</label>
            <select id="pricingCurrency">
              <option value="usd">USD ($)</option>
              <option value="eur">EUR (€)</option>
              <option value="gbp">GBP (£)</option>
              <option value="cad">CAD (CA$)</option>
              <option value="aud">AUD (A$)</option>
              <option value="brl">BRL (R$)</option>
            </select>
          </div>
        </div>
        <div class="pricing-header-row">
          <span class="ph-name">Item</span>
          <span class="ph-type">Type</span>
          <span class="ph-amount">Amount</span>
          <span class="ph-action"></span>
        </div>
        <div id="pricingItems"></div>
        <button class="add-item-btn" onclick="addPricingItem()">+ Add Line Item</button>
        <div class="pricing-totals-block">
          <div class="pricing-total-row">
            <span class="total-label">Total One-Time:</span>
            <span class="total-amount" id="totalOneTime">$0.00</span>
          </div>
          <div class="pricing-total-row">
            <span class="total-label">Total Setup Fees:</span>
            <span class="total-amount" id="totalSetup">$0.00</span>
          </div>
          <div class="pricing-total-row">
            <span class="total-label">Total Monthly:</span>
            <span class="total-amount" id="totalMonthly">$0.00</span>
          </div>
        </div>
        <div class="pricing-due-now">
          <div class="form-group">
            <label for="dueNowAmount"><strong>Due Now (amount to charge via Stripe)</strong></label>
            <input type="number" id="dueNowAmount" placeholder="0.00" step="0.01" min="0" oninput="schedulePreviewUpdate()">
          </div>
        </div>
        <div class="form-group" style="margin-top:16px;">
          <label for="pricingNotes">Pricing Notes</label>
          <textarea id="pricingNotes" rows="2" placeholder="Optional notes..."></textarea>
        </div>
      </div>

      <!-- I) Settings -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">I</span> Settings
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="settingsTone">Tone</label>
            <select id="settingsTone">
              <option value="Professional">Professional</option>
              <option value="Friendly">Friendly</option>
              <option value="Formal">Formal</option>
              <option value="Casual">Casual</option>
            </select>
          </div>
          <div class="form-group">
            <label for="settingsIndustry">Industry</label>
            <select id="settingsIndustry">
              <option value="Service Business">Service Business</option>
              <option value="Healthcare">Healthcare</option>
              <option value="Real Estate">Real Estate</option>
              <option value="Construction">Construction</option>
              <option value="Cleaning">Cleaning</option>
              <option value="Legal">Legal</option>
              <option value="Finance">Finance</option>
              <option value="E-commerce">E-commerce</option>
              <option value="Education">Education</option>
              <option value="SaaS">SaaS</option>
              <option value="Agency">Agency</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="toggle-wrap">
            <input type="checkbox" id="settingsShowImages" checked>
            <span class="toggle-label">Show system images in proposal</span>
          </label>
        </div>
        <div class="form-group">
          <label for="settingsPayText">Pay Button Text</label>
          <input type="text" id="settingsPayText" value="Pay Now" placeholder="Pay Now">
        </div>
      </div>

      <!-- J) Terms & Conditions -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">J</span> Terms & Conditions
        </div>
        <p style="color:var(--color-text-muted);font-size:0.8125rem;margin-bottom:12px;">
          Edit the terms template below. Use <code>{{company_name}}</code> as a placeholder for the client's company name and <code>{{date}}</code> for the proposal date. Changes are saved on the server and persist across sessions.
        </p>
        <div class="form-group">
          <textarea id="termsTemplate" rows="12" placeholder="Loading terms..." style="font-size:0.8125rem;line-height:1.7;"></textarea>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="saveTerms()">Save Terms</button>
        <span id="termsSaveStatus" style="margin-left:12px;font-size:0.8125rem;"></span>
      </div>

      <!-- Webhook (persistent) -->
      <div class="webhook-section">
        <h3>Make.com Webhook</h3>
        <p style="color:var(--color-text-muted);font-size:0.8125rem;margin-bottom:12px;">Set your webhook URL once. It will be saved on the server and used for all notifications (proposal created, signed, paid).</p>
        <div class="form-group">
          <label for="webhookUrl">Webhook URL</label>
          <input type="url" id="webhookUrl" placeholder="https://hook.us1.make.com/...">
        </div>
        <div class="action-bar" style="gap:8px;">
          <button class="btn btn-secondary btn-sm" onclick="saveWebhookUrl()">Save Webhook URL</button>
        </div>
        <div id="webhookSaveStatus" style="margin-top:8px;font-size:0.8125rem;"></div>
      </div>

      <!-- JSON Import -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">K</span> Import from JSON
        </div>
        <p style="color:var(--color-text-muted);font-size:0.8125rem;margin-bottom:12px;">
          Paste a full proposal JSON below to populate all fields automatically.
        </p>
        <div class="form-group">
          <textarea id="jsonImportField" rows="6" placeholder='Paste JSON here...' style="font-family:var(--font-mono);font-size:0.75rem;"></textarea>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="importFromJSON()">Import JSON</button>
        <span id="jsonImportStatus" style="margin-left:12px;font-size:0.8125rem;"></span>
      </div>

      <!-- Submit Proposal -->
      <div class="create-proposal-section-solid">
        <h3>Create & Send Proposal</h3>
        <p style="color:var(--color-text-secondary);font-size:0.8125rem;margin-bottom:16px;">This will save the proposal on the server, generate a unique URL, and send the link + client details to your Make.com webhook.</p>
        <button class="btn btn-primary" onclick="createProposal()" style="width:100%;padding:14px;font-size:1rem;">
          Create Proposal & Send to Make.com
        </button>
        <div class="status-panel" id="createStatus" style="margin-top:16px;display:none;">
          <div id="createStatusText"></div>
          <pre id="createResponse"></pre>
        </div>
      </div>

      <div style="height:40px;"></div>
    </div>

    <!-- RIGHT: Preview Panel -->
    <div class="builder-preview-panel">
      <div class="preview-header">
        <h4>Live Preview</h4>
        <button class="btn btn-secondary btn-sm" onclick="refreshPreview()">Refresh</button>
      </div>
      <iframe id="previewFrame" src="/static/proposal.html"></iframe>
    </div>

  </div>

  <!-- Hidden file input for JSON loading -->
  <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="handleFileLoad(event)">

  <script src="/static/builder.js"></script>
</body>
</html>
