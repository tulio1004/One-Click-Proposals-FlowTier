<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal Builder — FlowTier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/index.css">
  <!-- Quill Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    /* Quill Dark Theme Overrides */
    .ql-toolbar.ql-snow {
      background: var(--color-surface-raised, #1a2332);
      border-color: var(--color-border, #2a3a4a) !important;
      border-radius: var(--radius-md, 8px) var(--radius-md, 8px) 0 0;
    }
    .ql-container.ql-snow {
      border-color: var(--color-border, #2a3a4a) !important;
      border-radius: 0 0 var(--radius-md, 8px) var(--radius-md, 8px);
      background: var(--color-surface, #0d1520);
      color: var(--color-text, #e0e0e0);
      font-family: 'Inter', sans-serif;
      font-size: 0.875rem;
    }
    .ql-editor {
      min-height: 80px;
      color: var(--color-text, #e0e0e0);
      line-height: 1.6;
    }
    .ql-editor.ql-blank::before {
      color: var(--color-text-muted, #6b7a8d);
      font-style: italic;
    }
    .ql-snow .ql-stroke {
      stroke: var(--color-text-muted, #8899aa) !important;
    }
    .ql-snow .ql-fill,
    .ql-snow .ql-stroke.ql-fill {
      fill: var(--color-text-muted, #8899aa) !important;
    }
    .ql-snow .ql-picker {
      color: var(--color-text-muted, #8899aa) !important;
    }
    .ql-snow .ql-picker-options {
      background: var(--color-surface-raised, #1a2332) !important;
      border-color: var(--color-border, #2a3a4a) !important;
    }
    .ql-snow .ql-picker-item:hover,
    .ql-snow .ql-picker-item.ql-selected {
      color: var(--color-primary, #00E676) !important;
    }
    .ql-snow .ql-picker-label:hover .ql-stroke,
    .ql-snow .ql-picker-label.ql-active .ql-stroke {
      stroke: var(--color-primary, #00E676) !important;
    }
    .ql-toolbar button:hover .ql-stroke,
    .ql-toolbar button.ql-active .ql-stroke {
      stroke: var(--color-primary, #00E676) !important;
    }
    .ql-toolbar button:hover .ql-fill,
    .ql-toolbar button.ql-active .ql-fill {
      fill: var(--color-primary, #00E676) !important;
    }
    .ql-editor h1, .ql-editor h2, .ql-editor h3 {
      color: var(--color-text, #e0e0e0);
    }
    .ql-editor a {
      color: var(--color-primary, #00E676);
    }
    .ql-snow .ql-tooltip {
      background: var(--color-surface-raised, #1a2332) !important;
      border-color: var(--color-border, #2a3a4a) !important;
      color: var(--color-text, #e0e0e0) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .ql-snow .ql-tooltip input[type=text] {
      background: var(--color-surface, #0d1520) !important;
      border-color: var(--color-border, #2a3a4a) !important;
      color: var(--color-text, #e0e0e0) !important;
    }
    .quill-editor-wrap {
      margin-bottom: 4px;
    }
    .quill-editor-wrap .ql-editor {
      min-height: 100px;
    }
    .quill-editor-wrap.compact .ql-editor {
      min-height: 60px;
    }
    .quill-editor-wrap.tall .ql-editor {
      min-height: 200px;
    }
  </style>
</head>
<body>

  <div class="builder-layout">

    <!-- LEFT: Form Panel -->
    <div class="builder-form-panel" id="formPanel">

      <div class="builder-header">
        <div>
          <img src="/static/images/logo.webp" alt="FlowTier" style="height:36px;margin-bottom:4px;">
          <h1>Proposal Builder</h1>
        </div>
        <div class="action-bar">
          <a href="/" class="btn btn-secondary btn-sm" style="text-decoration:none;">Dashboard</a>
          <button class="btn btn-secondary btn-sm" onclick="copyJSON()">Copy JSON</button>
          <button class="btn btn-secondary btn-sm" onclick="downloadJSON()">Download JSON</button>
          <button class="btn btn-secondary btn-sm" onclick="loadJSON()">Load JSON</button>
          <a href="/logout" class="btn btn-secondary btn-sm" style="text-decoration:none;">Logout</a>
        </div>
      </div>

      <!-- A) Client Information -->
      <div class="builder-section">
        <div class="builder-section-title" style="display:flex;align-items:center;justify-content:space-between;">
          <div><span class="section-num">A</span> Client Information</div>
          <button class="btn btn-secondary btn-sm" onclick="openImportLeadModal()" style="font-size:0.75rem;padding:6px 14px;display:flex;align-items:center;gap:6px;">
            <span style="font-size:0.875rem;">&#128101;</span> Import Lead
          </button>
        </div>
        <div id="leadLinkedBanner" style="display:none;background:rgba(0,230,118,0.08);border:1px solid rgba(0,230,118,0.25);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:0.8125rem;color:#00E676;display:flex;align-items:center;gap:8px;">
          <span>&#9989;</span> <span id="leadLinkedText">Linked to lead</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clientName">Client Name</label>
            <input type="text" id="clientName" placeholder="John Smith">
          </div>
          <div class="form-group">
            <label for="clientCompany">Company</label>
            <input type="text" id="clientCompany" placeholder="Acme Corp">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="clientEmail">Email</label>
            <input type="email" id="clientEmail" placeholder="john@acme.com">
          </div>
          <div class="form-group">
            <label for="clientPhone">Phone</label>
            <input type="tel" id="clientPhone" placeholder="+1 (555) 123-4567">
          </div>
        </div>
      </div>

      <!-- Import Lead Modal -->
      <div id="importLeadModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:none;align-items:center;justify-content:center;">
        <div style="background:var(--color-bg-elevated,#111b27);border:1px solid var(--color-border,#2a3a4a);border-radius:12px;width:520px;max-height:80vh;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
          <div style="padding:20px 24px;border-bottom:1px solid var(--color-border-light,#1e2d3d);display:flex;align-items:center;justify-content:space-between;">
            <div>
              <h3 style="font-size:1rem;font-weight:700;color:var(--color-text,#e0e0e0);margin:0;">Import Lead from CRM</h3>
              <p style="font-size:0.75rem;color:var(--color-text-muted,#6b7a8d);margin:4px 0 0;">Search by name, company, or email</p>
            </div>
            <button onclick="closeImportLeadModal()" style="background:none;border:none;color:var(--color-text-muted,#6b7a8d);font-size:1.25rem;cursor:pointer;padding:4px 8px;">&#10005;</button>
          </div>
          <div style="padding:16px 24px;">
            <input type="text" id="leadSearchInput" placeholder="Search leads..." oninput="searchLeads()" style="width:100%;padding:10px 14px;background:var(--color-surface,#0d1520);border:1px solid var(--color-border,#2a3a4a);border-radius:8px;color:var(--color-text,#e0e0e0);font-size:0.875rem;font-family:inherit;outline:none;box-sizing:border-box;">
          </div>
          <div id="leadSearchResults" style="padding:0 24px 20px;max-height:400px;overflow-y:auto;"></div>
        </div>
      </div>

      <!-- B) Project Details -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">B</span> Project Details
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="projectName">Project Name</label>
            <input type="text" id="projectName" placeholder="Operations Automation">
          </div>
          <div class="form-group">
            <label for="proposalId">Proposal ID</label>
            <div class="dropdown-add-row">
              <input type="text" id="proposalId" placeholder="FT26P01" style="flex:1;">
              <button class="btn btn-primary btn-sm" type="button" onclick="generateProposalId()">Generate</button>
            </div>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="proposalSlug">Slug (auto-generated)</label>
            <input type="text" id="proposalSlug" placeholder="auto-generated-from-company" readonly style="opacity:0.7;cursor:default;">
          </div>
          <div class="form-group">
            <label for="proposalDate">Date</label>
            <input type="date" id="proposalDate">
          </div>
        </div>
      </div>

      <!-- C) Problem -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">C</span> Problem
        </div>
        <div class="form-group">
          <label>Problem Statement (Draft)</label>
          <div class="quill-editor-wrap" id="problemDraftWrap">
            <div id="problemDraft"></div>
          </div>
        </div>
      </div>

      <!-- D) Solution -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">D</span> Solution
        </div>
        <div class="form-group">
          <label>Solution Overview (Draft)</label>
          <div class="quill-editor-wrap" id="solutionDraftWrap">
            <div id="solutionDraft"></div>
          </div>
        </div>
      </div>

      <!-- E) Systems Selection -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">E</span> Systems
        </div>
        <div class="form-group">
          <label for="systemDropdown">Add a System</label>
          <div class="dropdown-add-row">
            <select id="systemDropdown">
              <option value="">— Select a system to add —</option>
            </select>
            <button class="btn btn-primary btn-sm" id="addSystemBtn" type="button">Add</button>
          </div>
        </div>
        <div id="addedSystemsList"></div>
      </div>

      <!-- F) Scope of Work -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">F</span> Scope of Work
        </div>
        <div id="scopeList"></div>
        <button class="add-item-btn" onclick="addScopeItem()">+ Add Item</button>
      </div>

      <!-- G) Timeline -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">G</span> Timeline
        </div>
        <div id="milestoneList"></div>
        <button class="add-item-btn" onclick="addMilestone()">+ Add Milestone</button>
      </div>

      <!-- H) Pricing -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">H</span> Pricing
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="pricingCurrency">Currency</label>
            <select id="pricingCurrency">
              <option value="usd">USD ($)</option>
              <option value="eur">EUR (€)</option>
              <option value="gbp">GBP (£)</option>
              <option value="cad">CAD (CA$)</option>
              <option value="aud">AUD (A$)</option>
              <option value="brl">BRL (R$)</option>
            </select>
          </div>
        </div>
        <div class="pricing-header-row">
          <span class="ph-name">Item</span>
          <span class="ph-type">Type</span>
          <span class="ph-amount">Amount</span>
          <span class="ph-action"></span>
        </div>
        <div id="pricingItems"></div>
        <button class="add-item-btn" onclick="addPricingItem()">+ Add Line Item</button>
        <div class="pricing-totals-block">
          <div class="pricing-total-row">
            <span class="total-label">Total One-Time:</span>
            <span class="total-amount" id="totalOneTime">$0.00</span>
          </div>
          <div class="pricing-total-row">
            <span class="total-label">Total Setup Fees:</span>
            <span class="total-amount" id="totalSetup">$0.00</span>
          </div>
          <div class="pricing-total-row">
            <span class="total-label">Total Monthly:</span>
            <span class="total-amount" id="totalMonthly">$0.00</span>
          </div>
        </div>
        <div class="pricing-due-now">
          <div class="form-group">
            <label for="dueNowAmount"><strong>Due Now (amount to charge via Stripe)</strong></label>
            <input type="number" id="dueNowAmount" placeholder="0.00" step="0.01" min="0" oninput="schedulePreviewUpdate()">
          </div>
        </div>
        <div class="form-group" style="margin-top:16px;">
          <label>Pricing Notes</label>
          <div class="quill-editor-wrap compact" id="pricingNotesWrap">
            <div id="pricingNotes"></div>
          </div>
        </div>
      </div>

      <!-- I) Settings -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">I</span> Settings
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="settingsTone">Tone</label>
            <select id="settingsTone">
              <option value="Professional">Professional</option>
              <option value="Friendly">Friendly</option>
              <option value="Formal">Formal</option>
              <option value="Casual">Casual</option>
            </select>
          </div>
          <div class="form-group">
            <label for="settingsIndustry">Industry</label>
            <select id="settingsIndustry">
              <option value="Service Business">Service Business</option>
              <option value="Healthcare">Healthcare</option>
              <option value="Real Estate">Real Estate</option>
              <option value="Construction">Construction</option>
              <option value="Cleaning">Cleaning</option>
              <option value="Legal">Legal</option>
              <option value="Finance">Finance</option>
              <option value="E-commerce">E-commerce</option>
              <option value="Education">Education</option>
              <option value="SaaS">SaaS</option>
              <option value="Agency">Agency</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="toggle-wrap">
            <input type="checkbox" id="settingsShowImages" checked>
            <span class="toggle-label">Show system images in proposal</span>
          </label>
        </div>
        <div class="form-group">
          <label for="settingsPayText">Pay Button Text</label>
          <input type="text" id="settingsPayText" value="Pay Now" placeholder="Pay Now">
        </div>
      </div>

      <!-- J) Terms & Conditions -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">J</span> Terms & Conditions
        </div>
        <p style="color:var(--color-text-muted);font-size:0.8125rem;margin-bottom:12px;">
          Edit the terms template below. Use <code>{{company_name}}</code> as a placeholder for the client's company name and <code>{{date}}</code> for the proposal date. Changes are saved on the server and persist across sessions.
        </p>
        <div class="form-group">
          <div class="quill-editor-wrap tall" id="termsTemplateWrap">
            <div id="termsTemplate"></div>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="saveTerms()">Save Terms</button>
        <span id="termsSaveStatus" style="margin-left:12px;font-size:0.8125rem;"></span>
      </div>

      <!-- Webhook (persistent) -->
      <div class="webhook-section">
        <h3>Make.com Webhook</h3>
        <p style="color:var(--color-text-muted);font-size:0.8125rem;margin-bottom:12px;">Set your webhook URL once. It will be saved on the server and used for all notifications (proposal created, signed, paid).</p>
        <div class="form-group">
          <label for="webhookUrl">Webhook URL</label>
          <input type="url" id="webhookUrl" placeholder="https://hook.us1.make.com/...">
        </div>
        <div class="action-bar" style="gap:8px;">
          <button class="btn btn-secondary btn-sm" onclick="saveWebhookUrl()">Save Webhook URL</button>
        </div>
        <div id="webhookSaveStatus" style="margin-top:8px;font-size:0.8125rem;"></div>
      </div>

      <!-- JSON Import -->
      <div class="builder-section">
        <div class="builder-section-title">
          <span class="section-num">K</span> Import from JSON
        </div>
        <p style="color:var(--color-text-muted);font-size:0.8125rem;margin-bottom:12px;">
          Paste a full proposal JSON below to populate all fields automatically.
        </p>
        <div class="form-group">
          <textarea id="jsonImportField" rows="6" placeholder='Paste JSON here...' style="font-family:var(--font-mono);font-size:0.75rem;"></textarea>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="importFromJSON()">Import JSON</button>
        <span id="jsonImportStatus" style="margin-left:12px;font-size:0.8125rem;"></span>
      </div>

      <!-- Save & Send Proposal -->
      <div class="create-proposal-section-solid">
        <h3>Save & Send Proposal</h3>
        <div style="display:flex;gap:12px;margin-bottom:12px;">
          <button class="btn btn-secondary" onclick="saveDraft()" style="flex:1;padding:14px;font-size:1rem;">
            &#128190; Save Draft
          </button>
          <button class="btn btn-primary" onclick="createProposal()" style="flex:1;padding:14px;font-size:1rem;">
            &#128640; Send Proposal
          </button>
        </div>
        <p style="color:var(--color-text-secondary);font-size:0.75rem;margin:0;">
          <strong>Save Draft</strong> &mdash; saves your work so you can finish later. Does not notify the client or change the lead stage.<br>
          <strong>Send Proposal</strong> &mdash; saves, generates the URL, fires the webhook to Make.com, and sets the lead stage to "Proposal Sent".
        </p>
        <div class="status-panel" id="createStatus" style="margin-top:16px;display:none;">
          <div id="createStatusText"></div>
          <pre id="createResponse"></pre>
        </div>
      </div>

      <div style="height:40px;"></div>
    </div>

    <!-- RIGHT: Preview Panel -->
    <div class="builder-preview-panel">
      <div class="preview-header">
        <h4>Live Preview</h4>
        <button class="btn btn-secondary btn-sm" onclick="refreshPreview()">Refresh</button>
      </div>
      <iframe id="previewFrame" src="/static/proposal.html"></iframe>
    </div>

  </div>

  <!-- Hidden file input for JSON loading -->
  <input type="file" id="jsonFileInput" accept=".json" style="display:none" onchange="handleFileLoad(event)">

  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script src="/static/builder.js"></script>
</body>
</html>
